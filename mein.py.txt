import discord
from discord.ext import commands
from dotenv import load_dotenv
import os
import json
from datetime import datetime

# Load environment variables
load_dotenv()

TOKEN = os.getenv("TOKEN")

# Intents
intents = discord.Intents.default()
intents.message_content = True
intents.members = True

bot = commands.Bot(command_prefix="!", intents=intents)

DATA_FILE = "likes.json"

# ---------- Data Functions ----------
def load_data():
    if not os.path.exists(DATA_FILE):
        return {"likes": {}, "cooldown": {}}
    with open(DATA_FILE, "r") as f:
        return json.load(f)

def save_data(data):
    with open(DATA_FILE, "w") as f:
        json.dump(data, f, indent=4)

# ---------- Events ----------
@bot.event
async def on_ready():
    print(f"âœ… Logged in as {bot.user}")

# ---------- Commands ----------
@bot.command()
async def like(ctx, member: discord.Member):
    if member.bot:
        await ctx.send("âŒ You cannot like bots.")
        return

    if member == ctx.author:
        await ctx.send("âŒ You can't like yourself.")
        return

    data = load_data()
    today = str(datetime.utcnow().date())
    giver_id = str(ctx.author.id)
    target_id = str(member.id)

    # Cooldown check (1 like per day)
    if data["cooldown"].get(giver_id) == today:
        await ctx.send("â³ You already gave a like today.")
        return

    data["likes"][target_id] = data["likes"].get(target_id, 0) + 1
    data["cooldown"][giver_id] = today

    save_data(data)

    await ctx.send(
        f"â¤ï¸ **Like Added!**\n"
        f"ğŸ‘¤ User: {member.mention}\n"
        f"ğŸ”¥ Total Likes: **{data['likes'][target_id]}**"
    )

@bot.command()
async def likes(ctx, member: discord.Member = None):
    member = member or ctx.author
    data = load_data()
    count = data["likes"].get(str(member.id), 0)

    await ctx.send(
        f"ğŸ”¥ **{member.display_name}'s Likes**\n"
        f"â¤ï¸ Total Likes: **{count}**"
    )

# ---------- Run Bot ----------
if TOKEN is None:
    print("âŒ TOKEN not found. Check .env or Render Environment Variables.")
else:
    bot.run(TOKEN)
